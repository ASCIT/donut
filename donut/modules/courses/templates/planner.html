{% extends 'layout.html' %}
{% block page %}
  <div class='col-md-8 col-md-offset-2' style='float: none'>
    <h3 id='warning'></h3>
    <h1>Course Planner</h1>
    <div class='row'>
      <div class='col-md-3'>
        <input class='form-control' id='search' placeholder='Search...' />
        <ul class='list-group' id='courses'>
          <li class='list-group-item'>Loading...</li>
        </ul>
      </div>
      <div class='col-md-9'>
        <table class='table table-bordered courses'>
          <thead>
            <tr>
              <th></th>
              {% for term_name in TERMS.values() %}
                <th class='term-title'>{{ term_name }}</th>
              {% endfor %}
            </tr>
          </thead>
          <tbody>
            {% for year in YEARS %}
              <tr>
                <td>{{ YEARS[year] }}</td>
                {% for term in TERMS %}
                  <td class='term-courses'>
                    <ul class='list-group term-courses-list' year={{ year }} term={{ term }}></ul>
                  </td>
                {% endfor %}
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
{% endblock %}
{% block styles %}
  {{ super() }}
  <style>
    #warning {
      float: right;
    }
    #courses {
      height: 600px;
      overflow-y: auto;
      margin-bottom: 0;
    }
    .units {
      font-weight: bold;
    }
    .instructor {
      font-style: italic;
    }
    .terms {
      width: 100%;
    }
    .terms td {
      text-align: center;
    }
    {% for term, name in TERMS.items() %}
      .terms:not(.{{ name }}) td:nth-child({{ term }}) {
        visibility: hidden;
      }
    {% endfor %}
    table.courses {
      height: 600px;
    }
    .term-title {
      text-align: center;
    }
    .term-courses {
      width: {{ 100 / TERMS|length }}%;
    }
    .term-courses-list {
      width: 100%;
      height: 100%;
    }
    .term-courses-list .list-group-item {
      display: flex;
      justify-content: space-around;
      padding: 0;
    }
  </style>
{% endblock %}
{% block scripts %}
  {{ super() }}
  <script>
    var courses = []
    var coursesList
    var terms = $('<table>').addClass('terms').append(
      $('<tr>').append(
        {% for term_name in TERMS.values() %}
          $('<td>').text('{{ term_name }}'),
        {% endfor %}
      )
    )
    function courseUnits(course) {
      return course.units.reduce(function(a, b) { return a + b })
    }
    function getYearTerm(courseList) {
      return ['year', 'term'].map(function(attr) {
        return Number(courseList.attr(attr))
      })
    }
    var draggedCourse = null
    function addCourse(course, courseList, skipAPIAdd) {
      var yearTerm = getYearTerm(courseList)
      var year = yearTerm[0], term = yearTerm[1]
      var termIndex = course.terms.indexOf(term)
      if (termIndex < 0) {
        return alert('Class is not offered that term')
      }
      var id = String(course.ids[termIndex])
      var units = courseUnits(course)
      var courseItem = $('<li>').addClass('list-group-item').append(
        $('<span>').text(
          course.number + ' (' + units + ' unit' + (units === 1 ? '': 's') + ')'
        ),
        $('<button>').addClass('btn btn-danger btn-xs')
          .click(function() {
            courseItem.remove()
            displayWarning('Saving...')
            $.ajax({
              type: 'GET',
              url: '/1/planner/course/' + id + '/drop/' + String(year),
              dataType: 'json',
              success: function(response) {
                displayWarning(response.success ? '' : response.message)
              },
              error: function() {
                displayWarning('Failed to drop course ' + course.number)
              }
            })
          })
          .append(
            $('<span>').addClass('glyphicon glyphicon-trash')
          )
      )
      courseList.append(courseItem)
      if (skipAPIAdd) return

      displayWarning('Saving...')
      $.ajax({
        type: 'GET',
        url: '/1/planner/course/' + id + '/add/' + String(year),
        dataType: 'json',
        success: function(response) {
          displayWarning(response.success ? '' : response.message)
        },
        error: function() {
          displayWarning('Failed to add course ' + course.number)
        }
      })
    }
    function displayCourses(matchingCourses) {
      coursesList.children().remove()
      matchingCourses.forEach(function(course) {
        var courseItem = $('<li>').addClass('list-group-item').append(
          $('<h4>').text(course.number),
          $('<h5>').text(course.name),
          $('<h5>').addClass('units').text(course.units.join('-'))
        )
        if (course.instructor) {
          courseItem.append(
            $('<h5>').addClass('instructor').text(course.instructor)
          )
        }
        var termsList = terms.clone()
        course.terms.forEach(function(term) {
          switch (term) {
            {% for term, name in TERMS.items() %}
              case {{ term }}:
                termsList.addClass('{{ name }}')
                break
            {% endfor %}
          }
        })
        courseItem
          .attr('draggable', 'true')
          .on('dragstart', function() { draggedCourse = course })
          .append(termsList)
        coursesList.append(courseItem)
      })
    }
    function displayWarning(message) {
      $('#warning').text(message).show()
    }
    $.ajax({
      type: 'GET',
      url: '{{ url_for("courses.planner_courses") }}',
      dataType: 'json',
      success: function(plannerCourses) {
        courses = plannerCourses
        displayCourses(courses)
      },
      error: function() { alert('Failed to load courses') }
    })
    $.ajax({
      type: 'GET',
      url: '{{ url_for("courses.planner_mine") }}',
      dataType: 'json',
      success: function(courses) {
        myCourses = courses
        courses.forEach(function(course) {
          var courseList = $('.term-courses-list[year=' + course.year + '][term=' + course.terms[0] + ']')
          addCourse(course, courseList, true)
        })
      }
    })
    $('input#search').keyup(function() {
      var query = $(this).val()
        .trim()
        .toLowerCase()
        .split(/[ /]+/)
      var matches = []
      courses.forEach(function(course) {
        var number = course.number.toLowerCase(),
          name = course.name.toLowerCase()
        var score = 0
        query.forEach(function(segment) {
          var numberIndex = number.indexOf(segment)
          if (numberIndex > -1) {
            score += segment.length
            if (numberIndex === 0 || number[numberIndex - 1] === ' ') score++
            var matchEnd = numberIndex + segment.length
            if (matchEnd === number.length || number[matchEnd] === ' ') score++
          }
          else if (name.indexOf(segment) > -1) score += segment.length * 0.1
        })
        if (score) matches.push({course: course, score: score})
      })
      displayCourses(
        matches
          .sort(function(a, b) { return b.score - a.score })
          .map(function(courseScore) { return courseScore.course })
      )
    })
    $(document).ready(function() {
      coursesList = $('ul#courses')
      $('.term-courses-list')
        .on('dragover', function(e) {
          e.preventDefault()
        })
        .on('drop', function(e) {
          e.stopPropagation() // Stops some browsers from redirecting.
          addCourse(draggedCourse, $(this))
          draggedCourse = null
        })
    })
  </script>
{% endblock %}