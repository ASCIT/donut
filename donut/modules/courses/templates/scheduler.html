{% extends 'layout.html' %}
{% block page %}
  <div class='col-md-10 col-md-offset-1' style='float: none'>
    <h1>Course Scheduler</h1>
    <div class='row'>
      <div class='col-md-3'>
        <div class='form-group'>
          <label for='term'>Term</label>
          <select class='form-control' id='term'>
            {% for term in terms %}
              <option value='{{ term["year"] }}-{{ term["term"] }}'>
                {{ TERMS[term["term"]] }} {{ term["year"] }}
              </option>
            {% endfor %}
          </select>
        </div>
        <input class='form-control' id='search' placeholder='Search...' />
        <ul class='list-group' id='courses'></ul>
      </div>
      <div class='col-md-9'>
        <div class='row' id='scheduler'>
          <div class='col-md-1'>
            {% for hour in range(START_HOUR, END_HOUR + 1) %}
              <div class='hour' style='top: {{ (hour - START_HOUR + 1) * HOUR_HEIGHT }}px'>
                {{ (hour + 11) % 12 + 1 }} {{ 'AM' if hour < 12 else 'PM' }}
              </div>
            {% endfor %}
          </div>
          {% for day in WEEK_DAYS %}
            <div class='col-md-2 day'>
              <span class='day-title'>{{ day }}</span>
            </div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
{% endblock %}
{% block styles %}
  {{ super() }}
  <style>
    input[type=checkbox] {
      left: 0;
    }
    #scheduler {
      height: 600px;
      overflow-x: hidden;
      overflow-y: auto;
    }
    #courses {
      height: 500px;
      overflow-y: auto;
    }
    .day-title, .interval-number {
      font-weight: bold;
    }
    .hour {
      position: absolute;
      width: 1200%; /* fill all 5 other columns */
      border-top: 1px solid orange;
    }
    .interval {
      position: absolute;
      border: 1px solid #999;
      border-radius: 5px;
      background: #fff;
      font-size: 12px;
    }
    .dropdown-menu.list-group {
      padding: 0;
      border: none;
    }
    .list-group-item.section {
      padding-top: 0;
      padding-bottom: 0;
    }
  </style>
{% endblock %}
{% block scripts %}
  {{ super() }}
  <script src='{{ url_for("static", filename="js/courses/search.js") }}'></script>
  <script>
    var SHOW_COURSES = 50
    var OM = 'OM,'
    var START_HOUR = {{ START_HOUR }}
    var HOUR_HEIGHT = {{ HOUR_HEIGHT }}
    var DAYS = {
      'M': 0,
      'T': 1,
      'W': 2,
      'R': 3,
      'F': 4
    }

    var termSelect, coursesList, search, dayLists
    var termLoadToken
    var termCourses = []
    var scheduledCourses = {}

    function loadTerm() {
      var yearTerm = termSelect.val().split('-')
      var loadToken = {}
      termLoadToken = loadToken
      coursesList.children().remove()
      coursesList.append(
        $('<li>').addClass('list-group-item').text('Loading...')
      )
      search.val('')
      $.ajax({
        type: 'GET',
        url: '/1/scheduler/courses/' + yearTerm.join('/'),
        success: function(courses) {
          if (termLoadToken !== loadToken) return

          termCourses = courses
          displayCourses(courses)
        }
      })
    }
    function addSection(course, sectionNumber) {
      scheduledCourses[[course.id, sectionNumber]] = true
      var sections = course.sections
      var section
      for (var i = 0; i < sections.length; i++) {
        if (sections[i].number === sectionNumber) {
          section = sections[i]
          break
        }
      }
      var intervals = []
      section.times.split('\n').forEach(function(time) {
        var daysStart = time.slice(0, OM.length) === OM ? OM.length : 0
        var space = time.indexOf(' ')
        if (space < 0) return // time is either "A" or "OM, A"

        var days = time.slice(daysStart, space)
        var interval = time.slice(space + 1)
        var heights = interval.split(' - ').map(function(time) {
          var hoursMinutes = time.split(':').map(Number)
          hour = hoursMinutes[0] + hoursMinutes[1] / 60
          return (hour - START_HOUR) * HOUR_HEIGHT
        })
        for (var day = 0; day < days.length; day++) {
          var weekday = DAYS[days[day]]
          var intervalItem = $('<div>')
            .addClass('interval')
            .attr('start', heights[0]).attr('end', heights[1])
            .css({
              top: String(heights[0] + HOUR_HEIGHT) + 'px',
              height: String(heights[1] - heights[0]) + 'px'
            })
            .append(
              $('<div>').addClass('interval-number').text(course.number),
              String(sectionNumber),
              $('<button>')
                .attr('type', 'button')
                .addClass('btn btn-danger btn-xs')
                .append($('<span>').addClass('glyphicon glyphicon-remove'))
                .click(function() {
                  intervals.forEach(function(element) { element.remove() })
                  intervals = null // allow GC
                  uncheckSection(course.id, sectionNumber)
                  scheduledCourses[[course.id, sectionNumber]] = false
                  fitIntervals()
                })
            )
          dayLists.eq(weekday).append(intervalItem)
          intervals.push(intervalItem)
        }
      })
      fitIntervals()
    }
    function removeSection(course, sectionNumber) {
      console.log('Remove', course, sectionNumber)
    }
    function uncheckSection(courseId, sectionNumber) {
      $(
        '[course=' +
        String(courseId) +
        '] input[type=checkbox][section=' +
        String(sectionNumber) +
        ']'
      ).prop('checked', false)
    }
    function fitIntervals() {
      dayLists.each(function(_, day) {
        var intervals = []
        $(day).children('.interval').each(function(_, element) {
          var $element = $(element)
          intervals.push({
            element: $element,
            start: Number($element.attr('start')),
            end: Number($element.attr('end'))
          })
        })
        intervals.sort(function(a, b) { return a.end - b.end })
        var intervalsToSchedule = intervals, remainingIntervals
        var lastEnd
        for (var indent = 0; intervalsToSchedule.length; indent++) {
          lastEnd = -Infinity
          remainingIntervals = []
          intervalsToSchedule.forEach(function(interval) {
            if (interval.start >= lastEnd) { // schedulable
              interval.indent = indent
              lastEnd = interval.end
            }
            else remainingIntervals.push(interval)
          })
          intervalsToSchedule = remainingIntervals
        }
        intervals.forEach(function(interval) {
          interval.element.css({
            width: 100 / indent + '%',
            left: 100 * interval.indent / indent + '%'
          })
        })
      })
    }
    function displayCourses(courses) {
      coursesList.children().remove()
      courses.slice(0, SHOW_COURSES).forEach(function(course) {
        var courseId = course.id
        var courseItem = $('<li>')
          .addClass('list-group-item')
          .attr('course', courseId)
          .append(
            $('<h4>').text(course.number),
            $('<h5>').text(course.name),
            $('<h5>').addClass('units').text(course.units.join('-'))
          )
        var sections = course.sections.map(function(section) {
          var number = section.number
          var sectionItem = $('<div>').append(
            $('<h5>').append(
              $('<input>')
                .attr({type: 'checkbox', section: number})
                .prop('checked', !!scheduledCourses[[courseId, number]])
                .change(function() {
                  ($(this).prop('checked') ? addSection : removeSection)
                    (course, number)
                }),
              String(number) + ' - ' + section.instructor
            )
          )
          if (section.grades) sectionItem.append($('<h6>').text(section.grades))
          section.times.split('\n').forEach(function(time) {
            sectionItem.append($('<h6>').text(time))
          })
          return sectionItem
        })
        if (sections.length > 1) {
          var dropdownMenu = $('<ul>').addClass('dropdown-menu list-group')
          sections.forEach(function(section) {
            dropdownMenu.append(
              $('<li>').addClass('list-group-item section').append(section)
            )
          })
          courseItem.append(
            $('<div>').addClass('dropdown').append(
              $('<button>')
                .addClass('btn btn-default dropdown-toggle')
                .attr({type: 'button', 'data-toggle': 'dropdown'})
                .append(
                  'Sections',
                  $('<span>').addClass('caret')
                ),
              dropdownMenu
            )
          )
        }
        else courseItem.append(sections[0])
        coursesList.append(courseItem)
      })
      $('.dropdown-toggle').dropdown()
    }

    $(document).ready(function() {
      termSelect = $('#term').change(loadTerm)
      coursesList = $('#courses')
      search = $('#search').keyup(function() {
        displayCourses(searchCourses(termCourses, $(this).val()))
      })
      dayLists = $('.day')

      loadTerm()
    })
  </script>
{% endblock %}